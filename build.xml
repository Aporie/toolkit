<?xml version="1.0" encoding="UTF-8" ?>

<project name="My subsite" default="help">

    <!-- Only output information on initial phing call. -->
    <property name="logoutput" value="true" />
    <property name="level" value="info" />

    <!-- Set starterkit properties. -->
    <if>
        <available file="${project.basedir}/vendor/ec-europa/ssk" />
        <then>
            <property name="subsite.starterkit.root" value="${project.basedir}/vendor/ec-europa/ssk" />
            <property name="project-is-subsite" value="1" />
        </then>
        <else>
            <property name="subsite.starterkit.root" value="${project.basedir}" override="true" />
        </else>
    </if>

    <!-- Load build properties. -->
    <if>
        <available file="${project.basedir}/build.properties.local" type="file" />
        <then>
            <property file="${project.basedir}/build.properties.local" logoutput="${logoutput}" />
        </then>
    </if>
    <if>
        <available file="${project.basedir}/build.properties" type="file" />
        <then>
            <property file="${project.basedir}/build.properties" logoutput="${logoutput}" />
        </then>
        <else>
            <input propertyName="create-project" defaultValue="yes" validargs="no,yes" message="No build.properties file detected. Would you like to create one?" />
            <if>
                <equals arg1="${create-project}" arg2="yes" />
                <then>
                    <property file="${subsite.starterkit.root}/build.properties.dist" logoutput="${logoutput}" />
                    <touch file="build.properties" />
                </then>
                <else>
                    <echo msg="Abandon ship.." />
                </else>
            </if>
        </else>
    </if>
    <property file="${subsite.starterkit.root}/build.properties.dist" logoutput="${logoutput}" />

    <!-- Help target to list commands. -->
    <target name="help" description="Phing target list">
        <exec executable="${phing.bin}"
              passthru="true">
            <arg value="-l"/>
        </exec>
    </target>

    <target name="create-subsite-directories">
        <mkdir dir="${subsite.resources.${dir}}" />
    </target>

    <!-- Set include path for custom tasks. -->
    <includepath classpath="${subsite.starterkit.root}/src/Phing" />

    <echo msg="Loading PHP Codesniffer Configuration task." level="${level}"  />
    <taskdef name="phpcodesnifferconfiguration" classname="\NextEuropa\Phing\PhpCodeSnifferConfigurationTask" />

    <echo msg="Loading Drush Makefile task." level="${level}"  />
    <taskdef name="drushmakefile" classname="\NextEuropa\Phing\DrushMakeFileTask" />

    <echo msg="Importing the Drush task." level="${level}" />
    <exec command="echo $(readlink -f ${subsite.starterkit.root}/includes/composer/vendor/drupal/phingdrushtask)" outputProperty="vendor-drupal-phingdrushtask" />
    <import file="${vendor-drupal-phingdrushtask}/import.xml"/>

    <echo msg="Importing the Behat task." level="${level}" />
    <exec command="echo $(readlink -f ${subsite.starterkit.root}/includes/composer/vendor/drupol/phingbehattask)" outputProperty="vendor-drupol-phingbehattask" />
    <import file="${vendor-drupol-phingbehattask}/import.xml"/>

    <!-- Import CPHP tasks @todo refractor when jenkins is active. -->
    <echo msg="Importing the ContinuousPHP specific Phing tasks." level="${level}"  />
    <import file="${subsite.starterkit.vendor}/continuousphp/phing-tasks/tasks.xml" />
    <import file="${subsite.starterkit.vendor}/continuousphp/aws-sdk-phing/tasks.xml" />

    <!-- Needs to be removed when phing adds relative symlink support -->
    <!-- https://github.com/phingofficial/phing/issues/684 -->
    <!-- https://github.com/phingofficial/phing/pull/695 -->
    <echo msg="Loading Relative Symlink task." level="${level}" />
    <taskdef name="rel-sym" classname="\NextEuropa\Phing\RelativeSymlinkTask" />

    <!-- Import project build xml file. -->
    <if>
        <and>
            <isset property="project-is-subsite" />
            <available file="${project.basedir}/build.project.xml" />
        </and>
        <then>
            <import file="${project.basedir}/build.project.xml" />
        </then>
    </if>

    <!-- Import starterkit build xml files. -->
    <import file="${subsite.starterkit.root}/includes/build/build.clone.xml" />
    <import file="${subsite.starterkit.root}/includes/build/build.composer.xml" />
    <import file="${subsite.starterkit.root}/includes/build/build.drush.xml" />
    <import file="${subsite.starterkit.root}/includes/build/build.docker.xml" />
    <import file="${subsite.starterkit.root}/includes/build/build.package.xml" />
    <import file="${subsite.starterkit.root}/includes/build/build.test.xml" />

    <!-- Disable output on consecutive phing calls. -->
    <property name="logoutput" value="false" override="true" />
    <property name="level" value="verbose" override="true" />

</project>
