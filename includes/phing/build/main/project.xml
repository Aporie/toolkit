<?xml version="1.0" encoding="UTF-8" ?>

<project name="project" description="Targets shared by differenct project types." default="">

    <target name="build-platform" description="Build NextEuropa Platform code without version control.">
        <delete dir="${build.platform.dir}" includeemptydirs="true" failonerror="true" quiet="true" />
        <if>
            <contains string="${profile}" substring="multisite" />
            <then>
                <phingcall target="project-platform-set-version" />
                <phingcall target="project-platform-package-unpack" />
                <phingcall target="project-modules-devops-dl" />
            </then>
            <else>
                <phingcall target="project-profile-build" />
            </else>
        </if>
        <phingcall target="project-subsite-files-setup" />
        <phingcall target="project-platform-set-htaccess" />
    </target>

    <target name="project-platform-enable-multisite" hidden="true" description="Enable multisite mode.">
        <if>
            <and>
                <equals arg1="${platform.multisite.mode}" arg2="1" />
            </and>
            <then>
                <exec command="echo ${project.url.base} |cut -c 8-" outputProperty="multisite_url" />
                <append destFile="${build.platform.dir.sites}/sites.php"
                        text="$sites['${multisite_url}'] = '${build.site}';" />
            </then>
            <else>
                <echo msg="Reached my multisite mode, let build normal stuff for ${project.url.base}."/>
            </else>
        </if>
    </target>

    <target name="project-profile-build" hidden="true" description="Build Drupal profile.">
        <drush command="dl" assume="yes">
            <param>"${profile}-${profile.core}"</param>
            <option name="destination">${project.basedir}</option>
            <option name="strict">0</option>
            <option name="drupal-project-rename">${build.dev}</option>
        </drush>
    </target>

    <target name="build-theme" hidden="true" description="Build EC Europa theme without version control."
        depends="
            theme-europa-download-extract,
            theme-europa-create-symlinks" />

    <target name="install-clean" description="Install NextEuropa site from scratch.">
        <exec command="chmod 775 ${build.platform.dir.settings}" />

        <phingcall target="drush-sql-create" />

        <if>
            <contains string="${profile}" substring="multisite" />
            <then>
                <if>
                    <and>
                        <equals arg1="${platform.package.db.cache}" arg2="1" />
                        <available file="${share.path.platform}/databases/platform-dev-${platform.package.version.current}/platform-dev-${platform.package.version.current}.sql" type="file" />
                    </and>
                    <then>
                        <phingcall target="drush-settings-generate" />
                        <exec command="${toolkit.dir.bin.drush} --root=${build.platform.dir} status bootstrap | grep -q Successful" returnProperty="drush-status-bootstrap" />
                        <if>
                            <not>
                                <equals arg1="${drush-status-bootstrap}" arg2="0" />
                            </not>
                            <then>
                                <phingcall target="drush-sql-import">
                                    <property name="database-file" value="${share.path.platform}/databases/platform-dev-${platform.package.version.current}/platform-dev-${platform.package.version.current}.sql" />
                                </phingcall>
                            </then>
                        </if>
                    </then>
                    <else>
                        <phingcall target="drush-site-install" />
                        <if>
                            <equals arg1="${platform.package.db.cache}" arg2="1" />
                            <then>
                                <phingcall target="drush-sql-dump">
                                    <property name="database-file" value="${share.path.platform}/databases/platform-dev-${platform.package.version.current}/platform-dev-${platform.package.version.current}.sql" />
                                </phingcall>
                            </then>
                        </if>
                    </else>
                </if>
            </then>
            <else>
                <phingcall target="drush-site-install" />
            </else>
        </if>
        <phingcall target="project-modules-install-en" />
        <phingcall target="project-modules-devel-en" />
        <phingcall target="reset-filesystem-permissions" />
        <phingcall target="drush-node-access-rebuild" />
    </target>

    <target name="install-clone" description="Install NextEuropa site with sanitized production data."
        depends="
            project-database-import,
            project-modules-devel-en,
            reset-filesystem-permissions" />

    <target name="project-composer-install" description="Runs composer install."
        hidden="true">
        <if>
            <available file="${composer-working-dir}/composer.json" type="file" />
            <then>
                <if>
                    <ispropertytrue property="composer-no-dev" />
                    <then>
                        <composer command="install" composer="${project.bin.composer}">
                            <arg value="--working-dir=${composer-working-dir}" />
                            <arg value="--no-interaction" />
                            <arg value="--no-suggest" />
                            <arg value="--no-dev" />
                            <arg value="--ansi" />
                        </composer>
                    </then>
                    <else>
                        <composer command="install" composer="${project.bin.composer}">
                            <arg value="--working-dir=${composer-working-dir}" />
                            <arg value="--no-interaction" />
                            <arg value="--no-suggest" />
                            <arg value="--ansi" />
                        </composer>
                    </else>
                </if>
            </then>
        </if>
    </target>

    <target name="project-database-download" hidden="true" description="Download sanitized production database from archive.">
        <if>
            <available file="${db-dl-file}" type="file" />
            <then>
                <echo msg="File ${db-dl-file} already downloaded." />
                <echo msg="Proceeding to import." />
            </then>
            <else>
                <if>
                    <isfalse value="${db.dl.filename}" />
                    <then>
                        <exec command='curl -s https://${db.dl.username}:${db.dl.password}@${db.dl.url}|egrep "li.*sql.gz"|head -1|cut -d\" -f2' outputProperty="db.dl.filename" checkreturn="true" />
                    </then>
                </if>
                <echo msg="Download the production database ${db.dl.filename}." />
                <phingcall target="package-download">
                    <property name="package-name" value="${db.dl.filename}" />
                    <property name="package-cache-location" value="${share.path.subsites.packages.database}/${project.id}" />
                    <property name="package-download-location" value="https://${db.dl.username}:${db.dl.password}@${db.dl.url}" />
                </phingcall>
                <exec command="gunzip ${share.path.subsites.packages.database}/${project.id}/${db.dl.filename}" checkreturn="true" passthru="false" logoutput="true" />
                <exec command='find ${share.path.subsites.packages.database}/${project.id} -maxdepth 1 -name "*.sql" -type f | head -1' outputproperty="db-dl-file" />
            </else>
        </if>
    </target>

    <target name="project-database-file" hidden="true" description="Check if database file is available.">
        <if>
            <available file="${project.db.file}" type="file" />
            <then>
                <property name="db-dl-file" value="${project.db.file}" />
            </then>
            <else>
                <exec command='find ${share.path.subsites.packages.database}/${project.id} -maxdepth 1 -name "*.sql" -type f | head -1' outputproperty="db-dl-file" />
            </else>
        </if>
    </target>

    <target name="project-database-link" hidden="true" description="Symlink database to dump.sql in project basedir." depends="project-database-file">
        <if>
            <available file="${db-dl-file}" type="file" />
            <then>
                <relsym link="${project.basedir}/dump.sql" target="${db-dl-file}" overwrite="true" />
            </then>
        </if>
    </target>

    <target name="project-database-import" hidden="true" description="Import database for project with drush."
        depends="
            project-database-file,
            project-database-download">
        <echo msg="Import production database." />
        <phingcall target="drush-sql-drop" />
        <phingcall target="drush-sql-create" />
        <phingcall target="drush-sql-import">
            <property name="database-file" value="${db-dl-file}" />
        </phingcall>
    </target>

    <target name="project-platform-package-unpack" hidden="true" description="Download and unpack platform deploy package.">
        <property file="${project.tmp.dir}/build.version.props" logoutput="${logoutput}" override="true" />
        <mkdir dir="${share.path.platform.packages.deploy}" />
        <phingcall target="package-download-unpack">
            <property name="package-name" value="platform-dev-${platform.package.version.current}.tar.gz" />
            <property name="package-cache-location" value="${share.path.platform.packages.deploy}" />
            <property name="package-download-location" value="https://platform-ci.ne-dev.eu/releases" />
            <property name="package-extract-location" value="${build.platform.dir}" />
        </phingcall>
    </target>

    <target name="project-platform-set-htaccess" hidden="true" description="Append htaccess config to root .htaccess.">
        <if>
            <istrue value="${build.platform.htaccess.append.text}" />
            <then>
                <if>
                    <available file="${build.platform.htaccess.append.text}" />
                    <then>
                        <append file="${build.platform.htaccess.append.text}" destFile="${build.platform.dir}/.htaccess" />
                    </then>
                    <else>
                        <append text="${build.platform.htaccess.append.text}" destFile="${build.platform.dir}/.htaccess" />
                    </else>
                </if>
            </then>
            <else>
                <echo msg="Appended no text to htaccess." />
            </else>
        </if>
    </target>

    <target name="project-platform-set-version" description="Save the platform version used for builds."
        hidden="true">
        <if>
            <matches string="${platform.package.version}" pattern="^[1-9]+\." />
            <then>
                <propertyregex property="platform.package.version.major" subject="${platform.package.version}" pattern="^([0-9]+)\." match="$1" override="true" />
                <propertyregex property="platform.package.version.minor" subject="${platform.package.version}" pattern="^[0-9]+\.([0-9]+)" match="$1" override="true" />
                <propertyregex property="platform.package.version.reference" subject="${platform.package.version}" pattern="^[0-9]+\.[0-9]+\.([0-9]+)" match="$1" override="true" />
                <if>
                    <matches string="${platform.package.version.minor}" pattern="[0-9]+" />
                    <then>
                        <php expression="${platform.package.version.minor} + 1" returnProperty="platform.upgrade" level="debug" />
                        <exec command="echo $(curl -s 'https://platform-ci.ne-dev.eu/releases/' | egrep -o 'platform-dev-${platform.package.version.major}\.${platform.package.version.minor}\.[0-9]+' | sed -e 's/^platform-dev-//' | sort -t. -rn -k1,1 -k2,2 -k3,3 | head -1)" outputproperty="platform.package.version.current" />
                        <exec command="echo $(curl -s 'https://platform-ci.ne-dev.eu/releases/' | egrep -o 'platform-dev-${platform.package.version.major}\.${platform.upgrade}\.[0-9]+' | sed -e 's/^platform-dev-//' | sort -t. -rn -k1,1 -k2,2 -k3,3 | head -1)" outputproperty="platform.package.version.next" />
                        <exec command="echo $(curl -s 'https://platform-ci.ne-dev.eu/releases/' | egrep -o 'platform-dev-${platform.package.version.major}\.[0-9]+\.[0-9]+' | sed -e 's/^platform-dev-//' | sort -t. -rn -k1,1 -k2,2 -k3,3 | head -1)" outputproperty="platform.package.version.latest" />
                    </then>
                </if>
                <if>
                    <matches string="${platform.package.version}" pattern="^[1-9]+\.[1-9]+\.[1-9]+$" />
                    <then>
                        <property name="platform.package.version.current" value="${platform.package.version}" override="true" />
                    </then>
                </if>
            </then>
        </if>
        <echo msg="The platform package version is set to ${platform.package.version}." />
        <echo msg="The build will be performed with version ${platform.package.version.current}." />
        <propertyregex property="platform.package.version.reference" subject="${platform.package.version.current}" pattern="^[0-9]+\.[0-9]+\.([0-9]+)" match="$1" override="true" />
        <if>
            <and>
                <matches string="${platform.package.version.next}" pattern="^[1-9]+\.[1-9]+\.[1-9]+$" />
                <versioncompare version="${platform.package.version.next}" desiredVersion="${platform.package.version}" operator="gt" />
            </and>
            <then>
                <php expression="${platform.package.version.minor} + 1" returnProperty="platform.upgrade" level="debug" />
                <echo msg="Last released deploy package is at ${platform.package.version.latest}." level="warning" />
                <echo msg="Please upgrade your platform version to ${platform.package.version.major}.${platform.upgrade}." level="warning" />
            </then>
        </if>
        <echoproperties regex="~^platform\.package\.version~" destfile="${project.tmp.dir}/build.version.props" />
    </target>

    <target name="project-subsite-files-setup" hidden="true" description="Create files directories for subsite.">
        <if>
            <istrue value="${build.tmp.dir}" />
            <then>
                <move file="${build.platform.dir.sites}/default/default.settings.php" tofile="${build.tmp.dir}/default.settings.php" />
                <mkdir dir="${build.platform.dir.sites}/all/drush" />
                <mkdir dir="${build.tmp.dir.files}/private_files" />
                <mkdir dir="${build.tmp.dir.files}/tmp" />
                <mkdir dir="${build.tmp.dir.files}/css_injector" />
                <mkdir dir="${build.tmp.dir.files}/js_injector" />
            </then>
        </if>
    </target>

    <target name="project-modules-devel-make" hidden="true" description="Makes the development resources with drush.">
        <echo msg="Make the development resources." />
        <phingcall target="drush-make-no-core">
            <property name="make-file" value="${resources.dir.devel.make}" />
            <property name="make-folder" value="${build.platform.dir.sites}" />
            <property name="make-destination" value="${build.site}" />
        </phingcall>
    </target>

    <target name="project-modules-devel-en" hidden="true" description="Enable development modules with drush.">
        <echoproperties prefix="devel.vars." destfile="${project.tmp.dir}/build.devel.vars.props" />
        <exec command="cat ${project.tmp.dir}/build.devel.vars.props | sed '/devel/,$!d'" outputProperty="variable-strings" />
        <foreach list="${variable-strings}" delimiter="${line.separator}" param="variable-string" target="drush-variable-set-string" />
        <phingcall target="drush-modules-enable">
            <property name="project.drupal.modules" value="${devel.mdls.en}" />
        </phingcall>
    </target>

    <target name="project-modules-devops-dl" hidden="true" description="Download and unpack fpfis resource package.">
        <mkdir dir="${share.path.platform.packages.deploy}" />
        <propertyregex property="drupal-core-version" subject="${profile.core}" pattern="([1-9])\.x" match="$1" casesensitive="false" defaultvalue="7"/>
        <phingcall target="package-download-unpack">
            <property name="package-name" value="d${drupal-core-version}.tar.gz" />
            <property name="package-cache-location" value="${share.path.platform.packages.deploy}" />
            <property name="package-download-location" value="https://github.com/ec-europa/platform-deploy/archive/fpfis-conf" />
            <property name="package-extract-location" value="${build.platform.dir}" />
            <property name="package-extract-options" value="--strip=1" />
        </phingcall>
    </target>

    <target name="project-modules-install-en" hidden="true" description="Install list of modules to enable by default.">
        <phingcall target="drush-modules-enable">
            <property name="project.drupal.modules" value="${project.install.modules}" />
        </phingcall>
    </target>

    <target name="project-platform-composer-dev" hidden="true" description="Run composer install with dev on platform.">
        <echo msg="Run 'composer install' in platform root." />
        <phingcall target="project-composer-install">
            <property name="composer-working-dir" value="${build.platform.dir}" override="true" />
        </phingcall>
    </target>

    <target name="project-platform-composer-no-dev" hidden="true" description="Run composer install without dev on platform.">
        <echo msg="Run 'composer install' in platform root." />
        <phingcall target="project-composer-install">
            <property name="composer-working-dir" value="${build.platform.dir}" override="true" />
            <property name="composer-no-dev" value="true" override="true" />
        </phingcall>
    </target>

    <target name="project-platform-set-docroot" hidden="true" description="Link the platform root to your docroot.">
        <relsym link="${project.docroot}" target="${build.platform.dir}" overwrite="true" />
    </target>

     <target name="project-properties-validate" hidden="true" description="Validate the build properties file." >
        <propval source="build.project.props" required="${toolkit.dir.incl.phing.props}/required.props" haltonerror="${build.haltonerror.props.validate}" logoutput="true" />
    </target >

    <target name="project-subsite-composer-no-dev" hidden="true" description="Run composer install without dev on subsite.">
        <echo msg="Run 'composer install' in the distribution folder for development purposes." />
        <phingcall target="project-composer-install">
            <property name="composer-working-dir" value="${build.dist.dir}" override="true" />
            <property name="composer-no-dev" value="false" override="true" />
        </phingcall>
    </target>

    <target name="project-subsite-composer-dev" hidden="true" description="Run composer install with dev on subsite.">
        <echo msg="Run 'composer install' in the subsite folder for development purposes." />
        <phingcall target="project-composer-install">
            <property name="composer-working-dir" value="${build.subsite.dir}" />
        </phingcall>
    </target>

</project>
