<?xml version="1.0" encoding="UTF-8" ?>

<project default="help">

    <!-- Import helper targets if called here directly. -->
    <if>
         <available file="help.xml" />
         <then>
             <import file="help.xml" />
         </then>
    </if>

    <!-- Create code base. -->
    <target
        name="build-project-platform"
        description="Build NextEuropa Platform code without version control."
        depends="
            build-project-subsite-backup,
            project-platform-delete,
            project-platform-package-unpack,
            build-project-subsite-restore" />

    <!-- Create code base. -->
    <target
        name="build-project-subsite"
        description="Build NextEuropa Subsite code without version control.">
        <echo msg="TODO: subsite builds not yet developed." />
    </target>

    <!-- Als long as there's only one theme we don't need to name it. -->
    <target
        name="build-project-theme"
        description="Build EC Europa theme without version control."
        depends="
        theme-europa-download-extract,
        theme-europa-create-symlinks" />

    <!-- Als long as there's only one theme we don't need to name it. -->
    <target
        name="build-project-theme-dev"
        description="Build EC Europa theme with version control."
        depends="
            theme-europa-repo-clone,
            theme-europa-build" />

    <target
        name="build-project-clone"
        description="Install NextEuropa site with production data."
        depends="
            project-database-download,
            drush-regenerate-settings,
            project-database-import,
            project-modules-devel-en" />

    <!-- Link site document root to Webserver document root. -->
    <target
        name="build-project-docroot"
        description="Create symlink from build to docroot.">
        <relsym link="${project.docroot}" target="${build.profile.dir}" overwrite="true" />
    </target>

    <target name="build-project-set-dist">
        <echo msg="Setting build dir to ${build.dist.dir}." />
        <property name="dir-build" value="${build.dist.dir}" override="true" />
        <echo msg="Setting profile dir to to ${build.dist.dir.profile}." />
        <property name="dir-profile" value="${build.dist.dir.profile}" override="true" />
        <echo msg="Setting profiles dir to to ${build.dist.dir.profiles}." />
        <property name="dir-profiles" value="${build.dist.dir.profiles}" override="true" />
    </target>

    <target name="build-project-set-dev">
        <echo msg="Setting build dir to ${build.profile.dir}." />
        <property name="dir-build" value="${build.profile.dir}" override="true" />
        <echo msg="Setting profile dir to to ${build.profile.dir.profile}." />
        <property name="dir-profile" value="${build.profile.dir.profile}" override="true" />
        <echo msg="Setting profiles dir to to ${build.profile.dir.profiles}." />
        <property name="dir-profiles" value="${build.profile.dir.profiles}" override="true" />
    </target>

    <target name="build-project-set-profile">
        <echo msg="Setting profile name to ${profile}." />
        <property name="profile-name" value="${profile}" override="true" />
        <echo msg="Setting profile make to ${profile.make}." />
        <property name="profile-make" value="${profile.make}" override="true" />
        <echo msg="Setting Drupal make to ${profile.core.make}." />
        <property name="drupal-make" value="${profile.core.make}" override="true" />
    </target>

    <!-- Update .htaccess. -->
    <target name="build-project-htaccess" description="Update .htaccess file.">
        <if>
            <istrue value="${build.profile.htaccess.append.text}" />
            <then>
                <echo msg="Appended text to htaccess." />
                <append destfile="${build.profile.dir/.htaccess" text="${build.profile.htaccess.append.text}" />
            </then>
            <else>
                <echo msg="Appended no text to htaccess." />
            </else>
        </if>
    </target>

    <!-- Delete the previous development build. -->
    <target name="project-platform-delete">
        <echo msg="Delete previous build." />
        <phingcall target="unprotect-folder">
            <property name="folder.to.unprotect" value="${build.profile.dir.settings}" />
            <property name="folder.to.unprotect" value="${build.subsite.dir}" />
        </phingcall>
        <echo msg="Unprotecting folder." />
        <phingcall target="delete-folder">
            <property name="folder.to.delete" value="${build.profile.dir}" />
        </phingcall>
    </target>

    <!-- Delete the previous development build. -->
    <target name="build-project-platform-delete">
        <echo msg="Delete previous build." />
        <phingcall target="unprotect-folder">
            <property name="folder.to.unprotect" value="${build.profile.sites}" />
        </phingcall>
        <echo msg="Unprotecting folder." />
        <phingcall target="delete-folder">
            <property name="folder.to.delete" value="${dir-build}" />
        </phingcall>
    </target>

    <!-- Unpack the platform. -->
    <target name="project-platform-package-unpack">
        <phingcall target="package-download-unpack">
            <property name="package-name" value="platform-dev-${profile.package.version.current}.tar.gz" />
            <property name="package-cache-location" value="${share.path.platform.packages.deploy}" />
            <property name="package-download-location" value="https://platform-ci.ne-dev.eu/releases" />
            <property name="package-extract-location" value="${build.profile.dir}" />
        </phingcall>
        <echo message="Generate site aliases." />
        <phingcall target="drush-generate-aliases" />
    </target>

    <!-- Install Composer dependencies without development dependencies. -->
    <target name="build-platform-composer-install">
        <echo msg="Run 'composer install' in platform root." />
        <composer command="install" composer="${project.bin.composer}">
            <arg value="--working-dir=${build.profile.dir}" />
            <arg value="--no-interaction" />
            <arg value="--no-suggest" />
            <arg value="--no-dev" />
            <arg value="--ansi" />
        </composer>
    </target>

    <!-- Install Composer dependencies, including optional development dependencies. -->
    <target name="build-platform-composer-install-dev">
        <composer command="install" composer="${project.bin.composer}">
            <arg value="--working-dir=${build.profile.dir}" />
            <arg value="--no-interaction" />
            <arg value="--no-suggest" />
            <arg value="--ansi" />
        </composer>
    </target>

    <!-- Install Composer dev dependencies for the subsite. -->
    <target name="project-subsite-composer-install">
        <echo msg="Run 'composer install' in the subsite folder for development purposes." />
        <composer command="install" composer="${project.bin.composer}">
            <arg value="--working-dir=${build.subsite.dir}" />
            <arg value="--no-interaction" />
            <!-- <arg value="no-plugins" /> -->
            <arg value="--no-suggest" />
            <arg value="--ansi" />
        </composer>
    </target>

    <!-- Setup file directory -->
    <target name="build-project-setup-files">
        <trycatch>
            <try>
                <phingcall target="drush-create-files-dirs" />
            </try>
            <catch>
                <if>
                    <istrue value="${build.subsite.dir.files}" />
                    <then>
                        <mkdir dir="${build.subsite.dir.files}/private_files" />
                        <mkdir dir="${build.subsite.dir.tmp}" />
                        <!-- Support CSS and JS injector. -->
                        <mkdir dir="${build.subsite.dir.files}/css_injector" />
                        <mkdir dir="${build.subsite.dir.files}/js_injector" />
                    </then>
                </if>
            </catch>
        </trycatch>
    </target>

    <!-- Generate the makefile used to download development modules. -->
    <target name="project-modules-devel-mf">
        <echo msg="Generate the makefile for development modules." />
        <if>
            <available file="${project.tmp.devel.make}" type="file" property="devel.makefile.available" />
            <then>
                <echo message="Deleting existing makefile." />
                <delete file="${project.tmp.devel.make}" failonerror="false" />
            </then>
        </if>
        <drushmf
            makeFile="${project.tmp.devel.make}"
            coreVersion="${profile.core}"
            projects="${devel.mdls.dl}"
            defaultProjectDir="${devel.mdls.dir}" />
    </target>
    <!-- Download development modules. -->
    <target name="project-modules-devel-dl" depends="project-modules-devel-mf">
        <echo msg="Download development modules." />
        <phingcall target="drush-make-no-core">
            <property name="drush.make.target.file" value="${project.tmp.devel.make}" />
            <property name="drush.make.root" value="${build.profile.dir}" />
        </phingcall>
    </target>

    <!-- Enable required modules after installation of the profile. -->
    <target name="project-modules-install-en">
        <phingcall target="drush-enable-modules">
            <property name="project.drupal.modules" value="${project.install.modules}" />
        </phingcall>
    </target>

    <!-- Enable development modules. -->
    <target name="project-modules-devel-en">
        <phingcall target="drush-enable-modules">
            <property name="project.drupal.modules" value="${devel.mdls.en}" />
        </phingcall>
    </target>

    <!-- Install the subsite. -->
    <target name="build-project-clean" description="Install NextEuropa site from scratch.">
         <mkdir dir="${build.subsite.dir}" />
         <phingcall target="build-project-setup-files" />
        <!--
            Ensure the settings folder is writable so the installer can create
            the settings.php file.
         -->
        <chmod mode="0775" failonerror="false" verbose="false" quiet="true">
            <fileset dir="${build.subsite.dir}" />
        </chmod>

        <!-- Regenerate aliases for this site to be included. -->
        <phingcall target="drush-generate-aliases" />

        <if>
            <and>
                <equals arg1="${profile.package.db.cache}" arg2="1" />
                <available file="${share.path.platform}/databases/platform-dev-${profile.package.version}/platform-dev-${profile.package.version}.sql" type="file" />
            </and>
            <then>
                <phingcall target="drush-regenerate-settings" />
                <exec command="${ssk.dir.bin.drush} --root=${build.profile.dir} status bootstrap | grep -q Successful" returnProperty="drush-status-bootstrap" />
                <if>
                    <not>
                        <equals arg1="${drush-status-bootstrap}" arg2="0"/>
                    </not>
                    <then>
                        <phingcall target="drush-sql-create" />
                        <phingcall target="drush-sql-import">
                            <property name="database-file" value="${share.path.platform}/databases/platform-dev-${profile.package.version}/platform-dev-${profile.package.version}.sql" />
                        </phingcall>
                    </then>
                </if> 
            </then>
            <else>
                <!-- Install site with drush. -->
                <phingcall target="drush-site-install" />
                <!-- Backup vanilla database. -->
                <if>
                    <equals arg1="${profile.package.db.cache}" arg2="1" />
                    <then>
                        <phingcall target="drush-sql-dump">
                            <property name="database-file" value="${share.path.platform}/databases/platform-dev-${profile.package.version}/platform-dev-${profile.package.version}.sql" />
                        </phingcall>
                    </then>
                </if>
            </else>
        </if>

        <!-- Enable solr if needed. -->
        <phingcall target="drush-enable-solr" />

        <!--
            Subsites are not allowed to use their own installation profile for
            historical reasons. The functionality is contained in one of more
            features and modules which need to be enabled after installation.
        -->
        <phingcall target="project-modules-install-en" />

        <!-- Rebuild node access after Subsites modules activation -->
        <phingcall target="drush-rebuild-node-access" />
    </target>

    <!-- Target to check if we have default settings, otherwise propose user to rebuild. -->
    <target name="check-for-default-settings-or-rebuild" hidden="true">
        <if>
            <not>
                <available file="${build.profile.dir.settings}/default.settings.php" type="file" property="build.settings.dir.default.settings" />
            </not>
            <then>
                <!-- If we can not find default settings in the build settings folder, prompt to ask user to rebuild. -->
                <echo msg="No default settings detected at ${build.profile.dir.settings}/default.settings.php." level="warning" />
                <propertyprompt propertyName="platform-rebuild" defaultValue="no" promptText="Do you wish to rebuild? (y/n)" />
                <if>
                    <equals arg1="${platform-rebuild}" arg2="y" />
                    <then>
                        <phingcall target="build-dev" />
                    </then>
                    <else>
                        <!-- If user chooses not to rebuild we have no other choice to fail the build. -->
                        <echo msg="Can not re-generate settings, canceling clone task." level="error" />
                        <fail />
                    </else>
                </if>
            </then>
            <else>
                <!-- If we have found the default settings inform the user we will proceed with generation. -->
                <echo msg="Default settings found at ${build.profile.dir.settings}/default.settings.php." />
                <echo msg="Proceeding with re-generation of the settings.php." />
            </else>
        </if>
        <phingcall target="project-modules-devel-en" />
    </target>

    <!-- Backs up files and folders listed in rebuild. properties in order to rebuild. -->
    <target name="build-project-subsite-backup">

        <!-- Check if site exists. -->
        <if>
            <available file="${build.subsite.dir}/settings.php" type="file"/>
            <then>
                <property name="site-detected" value="1" />
            </then>
            <else>
                <echo msg="No site installation detected. Skipping backup." />
            </else>
        </if>

        <if>
            <and>
                <equals arg1="${rebuild.auto}" arg2="0"/>
                <equals arg1="${site-detected}" arg2="1"/>
            </and>
            <then>
                <echo msg="Installed site detected." level="warning"/>
                <propertyprompt propertyName="build-project-subsite-backup-activated" promptText="Do you wish to backup site for this build? (y/n)" />
                <if>
                    <equals arg1="${build-project-subsite-backup-activated}" arg2="y" />
                    <then>
                        <property name="rebuild.auto" value="1" override="true"/>
                    </then>
                </if>
            </then>
        </if>
        <if>
            <and>
                <equals arg1="${rebuild.auto}" arg2="1"/>
                <equals arg1="${site-detected}" arg2="1"/>
            </and>
            <then>
                <if>
                    <!-- Delete any remains of previous backup attempts. -->
                    <available file="${rebuild.backup.destination}" type="dir"/>
                    <then>
                        <delete dir="${rebuild.backup.destination}" includeemptydirs="true"/>
                    </then>
                </if>
                <!-- Create backup directory. -->
                <mkdir dir="${rebuild.backup.destination}"/>
                <!-- Make the settings directory writable because we can not delete it otherwise -->
                <phingcall target="unprotect-folder">
                    <property name="folder.to.unprotect" value="${build.profile.dir.sites}" />
                </phingcall>
                <!-- Back up folders list. -->
                <foreach list="${rebuild.backup.folders}" param="site-item" target="build-project-subsite-backup-item" delimiter=";">
                    <property name="site-item-type" value="dir"/>
                </foreach>
                <!-- Back up files list. -->
                <foreach list="${rebuild.backup.files}" param="site-item" target="build-project-subsite-backup-item" delimiter=";">
                    <property name="site-item-type" value="file"/>
                </foreach>
            </then>
        </if>
        <if>
            <equals arg1="${build-project-subsite-backup-activated}" arg2="y" />
            <then>
                <property name="rebuild.auto" value="0" override="true"/>
            </then>
        </if>
    </target>

    <!-- Restoring sites directory if backed up before rebuild-dev. -->
    <target name="build-project-subsite-restore">

        <!-- Check if backup exists. -->
        <if>
            <available file="${rebuild.backup.destination}" type="dir"/>
            <then>
                <property name="backup-detected" value="1" />
            </then>
            <else>
                <echo msg="No site backup detected. Skipping restore." />
            </else>
        </if>
        <if>
            <and>
                <equals arg1="${rebuild.auto}" arg2="0"/>
                <equals arg1="${backup-detected}" arg2="1"/>
            </and>
            <then>
                <echo msg="Site backup detected." level="warning"/>
                <propertyprompt propertyName="build-project-subsite-restore-activated" promptText="Do you wish to restore site for this build? (y/n)" />
                <if>
                    <equals arg1="${build-project-subsite-restore-activated}" arg2="y" />
                    <then>
                        <property name="rebuild.auto" value="1" override="true"/>
                    </then>
                </if>
            </then>
        </if>
        <if>
            <and>
                <equals arg1="${rebuild.auto}" arg2="1"/>
                <equals arg1="${backup-detected}" arg2="1"/>
            </and>
            <then>
                <echo msg="Restoring site files and folders from ${rebuild.backup.destination}"/>
                <!-- Restore folders list. -->
                <foreach list="${rebuild.backup.folders}" param="site-item" target="build-project-subsite-restore-item" delimiter=";">
                    <property name="site-item-type" value="dir"/>
                </foreach>
                <!-- Restore files list. -->
                <foreach list="${rebuild.backup.files}" param="site-item" target="build-project-subsite-restore-item" delimiter=";">
                    <property name="site-item-type" value="file"/>
                </foreach>
                <!-- Delete the site backup directory. -->
                <delete dir="${rebuild.backup.destination}" includeemptydirs="true"/>
            </then>
        </if>
    </target>

    <!-- Backs up a site item from the platform that will be removed in order to rebuild. -->
    <target name="build-project-subsite-backup-item" hidden="true">
        <php expression='dirname("${site-item}")' returnProperty="site-item-dir"/>
        <property name="site-item-backup-dir" value="${site-item-dir}">
            <filterchain>
                <replaceregexp>
                    <regexp pattern="${build.profile.dir}" replace="${rebuild.backup.destination}" ignoreCase="false"/>
                </replaceregexp>
            </filterchain>
        </property>
        <if>
            <available file="${site-item}" type="${site-item-type}"/>
            <then>
                <if>
                    <not>
                        <available file="${site-item-backup-dir}" type="dir"/>
                    </not>
                    <then>
                        <mkdir dir="${site-item-backup-dir}"/>
                    </then>
                </if>
                <move file="${site-item}" todir="${site-item-backup-dir}" includeemptydirs="true"/>
            </then>
            <else>
                <php expression='ucwords("${site-item-type}")' returnProperty="site-item-type-capitalized"/>
                <echo msg="Skipping ${site-item}. ${site-item-type-capitalized} not found." level="warning"/>
            </else>
        </if>
    </target>

    <!-- Restores a site item from the rebuild.backup.destination to the new build. -->
    <target name="build-project-subsite-restore-item" hidden="true">
        <property name="site-item-backup" value="${site-item}">
            <filterchain>
                <replaceregexp>
                    <regexp pattern="${build.profile.dir}" replace="${rebuild.backup.destination}" ignoreCase="false"/>
                </replaceregexp>
            </filterchain>
        </property>
        <if>
            <available file="${site-item-backup}" type="${site-item-type}"/>
            <then>
                <php expression='dirname("${site-item}")' returnProperty="site-item-dir"/>
                <if>
                    <not>
                        <available file="${site-item-dir}" type="dir"/>
                    </not>
                    <then>
                        <mkdir dir="${site-item-dir}"/>
                    </then>
                </if>
                <move file="${site-item-backup}" todir="${site-item-dir}" includeemptydirs="true"/>
            </then>
            <else>
                <php expression='ucwords("${site-item-type}")' returnProperty="site-item-type-capitalized"/>
                <echo msg="Skipping ${site-item}. ${site-item-type-capitalized} not found." level="warning"/>
            </else>
        </if>
    </target>

    <!-- Import production database. -->
    <target name="project-database-import" depends="project-database-download">
        <echo msg="Import production database." />
        <!-- Drop database, create if necessary and import the dump. -->
        <phingcall target="drush-sql-drop" />
        <phingcall target="drush-sql-create" />
        <phingcall target="drush-sql-import">
            <property name="database-file" value="tmp/${gunzipped.filename}" />
        </phingcall>
        <phingcall target="drush-registry-rebuild" />
    </target>

    <!-- Download the production database. -->
    <target name="project-database-download" >
        <echo msg="Download the production database." />
        <!--Strips gz suffix. -->
        <php expression="substr('${db.dl.filename}', 0, -3)" returnProperty="gunzipped.filename" level="debug"/>
        <if>
            <not>
                <!-- Check if we have a previously downloaded dump available. -->
                <available file="tmp/${gunzipped.filename}" type="file" property="gunzipped.db" />
            </not>
            <then>
                <!-- If not available, download and unzip the file. -->
                <phingcall target="project-database-wget" />
                <exec command="gunzip tmp/${db.dl.filename}" checkreturn="true" passthru="false" logoutput="true" />
            </then>
            <else>
                <!-- Inform user if file was already downloaded. -->
                <echo msg="File ${gunzipped.filename} already downloaded." />
                <echo msg="Proceeding to import." />
            </else>
        </if>
    </target>

    <!-- Target to actually fetch the database dump. -->
    <target name="project-database-wget">
        <!--Generate .htaccess credential property if needed, empty if not. -->
        <if>
            <or>
                <equals arg1="${db.dl.url.htaccess.username}" arg2="" />
                <equals arg1="${db.dl.url.htaccess.password}" arg2="" />
            </or>
            <then>
                <!-- If username or password is not provided, empty the credential string. -->
                <property name="db.dl.url.credentials"  value="" override="true" />
            </then>
            <else>
                <!-- If username or password is provided, build the credential string. -->
                <property name="db.dl.url.credentials"  value="${db.dl.url.htaccess.username}:${db.dl.url.htaccess.password}@" override="true"  />
            </else>
        </if>
        <!-- Attempt to download the database dump. -->
        <exec command="wget https://${db.dl.url.credentials}${db.dl.url}${db.dl.filename}" dir="tmp" checkreturn="false" passthru="false" outputProperty="db.dl.download" />
        <if>
            <!-- Upon success inform the user. -->
            <contains string="${db.dl.download}" substring="200" />
            <then>
                <echo msg="Database successfully downloaded." />
            </then>
            <!-- When denied access, prompt the user for credentials and retry the download. -->
            <elseif>
                <contains string="${db.dl.download}" substring="401" />
                <then>
                    <phingcall target="prompt-for-credentials-and-retry" />
                </then>
            </elseif>
            <!-- Otherwise we fail the build and display the download message. -->
            <else>
                <echo msg="Failed to download the database dump. Result of wget:" level="error" />
                <echo msg="${db.dl.download}" level="error" />
                <fail />
            </else>
        </if>
    </target>

    <!-- Simple prompt for user credentials and recurse into project-database-wget. -->
    <target name="prompt-for-credentials-and-retry" hidden="true">
        <input propertyName="db.dl.url.htaccess.username" message="Please enter your username." />
        <input hidden="true" propertyName="db.dl.url.htaccess.password" message="Please enter your password." />
        <phingcall target="project-database-wget" />
    </target>

    <target name="project-validate-properties">
        <!--forbidden="${ssk.incl.phing.props}/build.properties.forbidden"-->
        <propval
                source="build.properties"
                required="${ssk.dir.incl.phing.props}/required.props"
                haltonerror="${build.haltonerror.props.validate}"
                logoutput="${logoutput}"
        />
    </target>

</project>
