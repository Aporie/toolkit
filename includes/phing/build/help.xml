<?xml version="1.0" encoding="UTF-8" ?>

<project default="help">

    <!-- Help function to display the targets. -->
    <target name="help" hidden="true">
        <exec command="${phing.bin} -f ${phing.file} -l" outputProperty="phing-targets" />
        <echo msg="${phing-targets}" />
    </target>

    <!-- Highest priority to env variables. -->
    <property environment="env" />

    <!-- Load build properties. -->
    <if>
        <available file="build.properties.local" type="file" />
        <then>
            <property file="build.properties.local" />
        </then>
    </if>
    <if>
        <available file="build.properties" type="file" />
        <then>
            <property file="build.properties" />
        </then>
        <elseif>
            <equals arg1="${project.basedir}" arg2="${ssk.root}" />
            <then>
                <fail msg="${project.basedir} ---- ${ssk.root} Without a build.properties" />
            </then>
        </elseif>
    </if>
    <if>
        <available file="vendor/ec-europa/ssk/build.properties.dist" type="file" />
        <then>
            <property file="vendor/ec-europa/ssk/build.properties.dist" />
        </then>
    </if>

    <!-- Set compose project name if available. -->
    <if>
        <isset property="env.COMPOSE_PROJECT_NAME" />
        <then>
            <property name="docker.project.id" value="${env.COMPOSE_PROJECT_NAME}" override="true" />
        </then>
    </if>

    <!-- Check if site exists. -->
    <if>
        <available file="${project.build.settings.dir}/settings.php" type="file"/>
        <then>
            <property name="site-detected" value="1" />
        </then>
    </if>

    <!-- Check if backup exists. -->
    <if>
        <available file="${project.rebuild.backup.destination}" type="dir"/>
        <then>
            <property name="backup-detected" value="1" />
        </then>
    </if>

    <!-- Check type of project and import it's build file.. -->
    <if>
        <available file="${project.resources.profiles.dir}" type="dir"/>
        <then>
            <import file="${ssk.build}/platform.xml" />
        </then>
        <else>
            <import file="${ssk.build}/subsite.xml" />
        </else> 
    </if>

    <!-- Echo the composer hook phingcalls. -->
    <target name="composer-echo-hook-phingcalls" hidden="true">
        <echoproperties prefix="composer.hook."/>
    </target>

    <!-- Copies a given folder to a new location. -->
    <target name="copy-folder" hidden="true">
        <copy todir="${copy.destination.path}" haltonerror="${copy.path.haltonerror}">
            <fileset dir="${copy.source.path}" defaultexcludes="false" />
        </copy>
    </target>

    <!-- Delete a given folder. -->
    <target name="delete-folder" hidden="true">
        <!-- Use the faster native command on UNIX systems. -->
        <if>
            <os family="unix" />
            <then>
                <echo msg='rm -rf "${folder.to.delete}"' />
                <exec
                    command='rm -rf "${folder.to.delete}"'
                    dir="${project.basedir}"
                    passthru="true"
                    checkreturn="true"
                />
            </then>
            <else>
                <delete dir="${folder.to.delete}" includeemptydirs="true" failonerror="false" />
            </else>
        </if>
    </target>

    <!-- Make the given folder writeable. -->
    <target name="unprotect-folder" hidden="true">
        <!-- This should only be used on folders that need to be removed. -->
        <if>
            <available file="${folder.to.unprotect}" type="dir" />
            <then>
                <chmod mode="0777" failonerror="true" verbose="false" quiet="true">
                    <fileset dir="${folder.to.unprotect}" />
                </chmod>
            </then>
        </if>
    </target>

   <!-- Create temp dirs. -->
    <target name="create-tmp-dirs" hidden="true">
        <if>
            <!-- Create the global cache directory if it doesn't exist. -->
            <not>
                <available file="${platform.package.cachedir}" type="dir"/>
            </not>
            <then>
                <mkdir dir="${platform.package.cachedir}"/>
            </then>
            <else>
                <echo msg="Directory ${platform.package.cachedir} exists."/>
            </else>
        </if>
    </target>

</project>
