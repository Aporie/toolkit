<?xml version="1.0" encoding="UTF-8" ?>

<project default="help">

    <!-- Help function to display the targets. -->
    <target name="help" hidden="true">
        <exec command="${ssk.dir.bin.phing} -f ${phing.file} -l | sed -n '/Main targets/,$p'" outputproperty="phing-targets" logoutput="false" />
        <echo msg="${line.separator}${phing-targets}" />
    </target>

    <!-- Enable output initially to show loads and logging. -->
    <property name="logoutput" value="true" />
    <property name="level" value="info" />

    <!-- Load build properties. -->
    <if>
        <available file="build.properties.local" type="file" />
        <then>
            <property file="build.properties.local" logoutput="${logoutput}" />
        </then>
    </if>
    <if>
        <available file="build.properties" type="file" />
        <then>
            <property file="build.properties" logoutput="${logoutput}" />
        </then>
        <elseif>
            <equals arg1="${project.basedir}" arg2="${ssk.dir}" />
            <then>
                <fail msg="${project.basedir} ---- ${ssk.dir} Without a build.properties" />
            </then>
        </elseif>
    </if>
    <if>
        <available file="${ssk.dir.incl.phing.props}/main.props" type="file" />
        <then>
            <property file="${ssk.dir.incl.phing.props}/main.props" logoutput="false" />
        </then>
    </if>

    <!-- Load version properties if available. -->
    <property file="${project.tmp.dir}/build.properties.version" logoutput="${logoutput}" />

    <!-- Check type of project and import it's build file. -->
    <if>
        <available file="${lib.dir.profiles}" type="dir"/>
        <then>
            <import file="${ssk.dir.incl.phing.build}/platform.xml" />
        </then>
        <else>
            <import file="${ssk.dir.incl.phing.build}/subsite.xml" />
        </else>
    </if>

    <!-- Get latest stable if major version is defined. -->
    <target name="project-set-platform-version" hidden="true">
        <if>
            <matches string="${profile.package.version}" pattern="^[1-9]+\." />
            <then>
                <propertyregex
                    property="profile.package.version.major"
                    subject="${profile.package.version}"
                    pattern="^([1-9]+)\."
                    match="$1"
                    override="true" />
                <propertyregex
                    property="profile.package.version.minor"
                    subject="${profile.package.version}"
                    pattern="^[1-9]+\.([1-9]+)"
                    match="$1"
                    override="true" />
                <propertyregex
                    property="profile.package.version.reference"
                    subject="${profile.package.version}"
                    pattern="^[1-9]+\.[1-9]+\.([1-9]+)"
                    match="$1"
                    override="true" />
                <if>
                    <isset property="profile.package.version.minor" />
                    <then>
                        <php expression="${profile.package.version.minor} + 1" returnProperty="platform.upgrade" level="debug" />
                        <exec command="echo $(curl -s 'https://platform-ci.ne-dev.eu/releases/' | grep -oP 'href=&quot;platform-dev-\K${profile.package.version.major}\.${profile.package.version.minor}\.[0-9]+' | sort -t. -rn -k1,1 -k2,2 -k3,3 | head -1)" outputproperty="profile.package.version.current" />
                        <exec command="echo $(curl -s 'https://platform-ci.ne-dev.eu/releases/' | grep -oP 'href=&quot;platform-dev-\K${profile.package.version.major}\.${platform.upgrade}\.[0-9]+' | sort -t. -rn -k1,1 -k2,2 -k3,3 | head -1)" outputproperty="profile.package.version.next" />
                        <exec command="echo $(curl -s 'https://platform-ci.ne-dev.eu/releases/' | grep -oP 'href=&quot;platform-dev-\K${profile.package.version.major}\.[0-9]+\.[0-9]+' | sort -t. -rn -k1,1 -k2,2 -k3,3 | head -1)" outputproperty="profile.package.version.latest" />
                    </then>
                </if>
            </then>
        </if>
        <if>
            <and>
                <matches string="${profile.package.version.current}" pattern="^[1-9]+\.[1-9]+\.[1-9]+$" />
                <versioncompare
                    version="${profile.package.version.current}"
                    desiredVersion="${profile.package.version}"
                    operator="gt" />
            </and>
            <then>
                <echo msg="The platform package version is set to ${profile.package.version}." />
                <echo msg="The build will be performed with version ${profile.package.version.current}." />
                <propertyregex
                    property="profile.package.version.reference"
                    subject="${profile.package.version.current}"
                    pattern="^[1-9]+\.[1-9]+\.([1-9]+)"
                    match="$1"
                    override="true" />
                <property name="profile.package.version" value="${profile.package.version.current}" override="true" />
            </then>
        </if>
        <if>
            <and>
                <matches string="${profile.package.version.next}" pattern="^[1-9]+\.[1-9]+\.[1-9]+$" />
                <versioncompare
                    version="${profile.package.version.next}"
                    desiredVersion="${profile.package.version}"
                    operator="gt" />
            </and>
            <then>
                <!-- TODO: this allows for automatic upgrading if we were to provide a setting. -->
                <php expression="${profile.package.version.minor} + 1" returnProperty="platform.upgrade" level="debug" />
                <echo msg="Last released deploy package is at ${profile.package.version.latest}." level="warning" />
                <echo msg="Please upgrade your platform version to ${profile.package.version.major}.${platform.upgrade}." level="warning" />
            </then>
        </if>
        <echoproperties regex="~^project\.profile\.package\.version~" destfile="${project.tmp.dir}/build.properties.version" />
    </target>

    <!-- Check if site exists. -->
    <if>
        <available file="${build.settings.dir}/settings.php" type="file"/>
        <then>
            <property name="site-detected" value="1" />
        </then>
    </if>

    <!-- Check if backup exists. -->
    <if>
        <available file="${rebuild.backup.destination}" type="dir"/>
        <then>
            <property name="backup-detected" value="1" />
        </then>
    </if>

    <!-- Echo the composer hook phingcalls. -->
    <target name="composer-echo-hook-phingcalls" hidden="true">
        <echoproperties prefix="composer.hook."/>
    </target>

    <!-- Echo the git hook phingcalls. -->
    <target name="git-echo-hook-phingcalls" hidden="true">
        <echoproperties prefix="git.hook."/>
    </target>

    <!-- Copies a given folder to a new location. -->
    <target name="copy-folder" hidden="true">
        <copy todir="${copy.destination.path}" haltonerror="${build.haltonerror.dir.copy}">
            <fileset dir="${copy.source.path}" defaultexcludes="false" />
        </copy>
    </target>

    <!-- Delete a given folder. -->
    <target name="delete-folder" hidden="true">
        <!-- Use the faster native command on UNIX systems. -->
        <if>
            <os family="unix" />
            <then>
                <echo msg="Deleting folder ${folder.to.delete}." />
                <exec
                    command='rm -rf "${folder.to.delete}"'
                    dir="${project.basedir}"
                    passthru="true"
                    checkreturn="true"
                />
            </then>
            <else>
                <echo msg="Deleting folder ${folder.to.delete}." />
                <delete dir="${folder.to.delete}" includeemptydirs="true" failonerror="false" />
            </else>
        </if>
    </target>

    <!-- Reset all file permission to Drupals recommendation for the lib dir. -->
    <target name="reset-filesystem-permissions-lib">
        <echo msg="Resetting permissions for ${lib.dir}" />
        <phingcall target="reset-filesystem-permissions">
            <property name="target-dir" value="${lib.dir}" />
        </phingcall>
    </target>

    <!-- Reset all file permission to Drupals recommendation for the build dir. -->
    <target name="reset-filesystem-permissions-build">
        <echo msg="Resetting permissions for ${build.profile.dir}" />
        <phingcall target="reset-filesystem-permissions">
            <property name="target-dir" value="${build.profile.dir}" />
        </phingcall>
    </target>

    <!-- Reset all file permission to Drupals recommendation for the build dir. -->
    <target name="reset-filesystem-permissions-dist">
        <echo msg="Resetting permissions for ${build.dist.dir}" />
        <phingcall target="reset-filesystem-permissions">
            <property name="target-dir" value="${build.dist.dir}" />
        </phingcall>
    </target>

    <!-- Reset all file permission to Drupals recommendation. -->
    <!-- https://www.drupal.org/node/244924#script-based-on-guidelines-given-above -->
    <target name="reset-filesystem-permissions" hidden="true">
        <if>
            <available file="${target-dir}" type="dir" />
            <then>
                <chmod mode="0750" failonerror="true" verbose="false" quiet="true">
                    <fileset dir="${target-dir}" excludes="**/sites/*/files">
                        <type type="dir" />
                    </fileset>
                </chmod>
                <chmod mode="0640" failonerror="true" verbose="false" quiet="true">
                    <fileset dir="${target-dir}" excludes="**/sites/*/files">
                        <type type="file" />
                    </fileset>
                </chmod>
                <if>
                    <not>
                        <and>
                            <contains string="${target-dir}" substring="${lib.dir}" />
                            <contains string="${target-dir}" substring="${build.dist.dir}" />
                        </and>
                    </not>
                    <then>
                        <chmod mode="0770" failonerror="true" verbose="false" quiet="true">
                            <fileset dir="${target-dir}" includes="**/sites/*/files">
                                <type type="dir"/>
                            </fileset>
                        </chmod>
                        <chmod mode="0660" failonerror="true" verbose="false" quiet="true">
                            <fileset dir="${target-dir}" includes="**/sites/*/files">
                                <type type="file" />
                            </fileset>
                        </chmod>
                    </then>
                </if>
            </then>
        </if>
    </target>

    <!-- Make the given folder writeable. -->
    <target name="unprotect-folder" hidden="true">
        <!-- This should only be used on folders that need to be removed. -->
        <if>
            <available file="${folder.to.unprotect}" type="dir" />
            <then>
                <chmod mode="0777" failonerror="true" verbose="false" quiet="true">
                    <fileset dir="${folder.to.unprotect}" />
                </chmod>
            </then>
        </if>
    </target>

    <!-- Download and unpack package. -->
    <target name="package-download-unpack" depends="package-download, package-unpack" hidden="true">
        <echo msg="Package ${package-name} successfully unpacked." />
    </target>

    <!-- Download the package. -->
    <target name="package-download" hidden="true">
        <if>
            <available file="${package-cache-location}/${package-name}" type="file"/>
            <then>
                <echo msg="Package ${package-name} already downloaded."/>
            </then>
            <else>
                <trycatch>
                    <try>
                        <mkdir dir="${package-cache-location}" />
                        <echo msg="Starting download for package ${package-name}."/>
                        <exec command="curl -L${project.curl.progress} -o ${package-cache-location}/${package-name} ${package-download-location}/${package-name}" passthru="true" checkreturn="true"/>
                        <echo msg="Successfully downloaded package ${package-name}."/>
                    </try>
                    <catch>
                        <fail msg="Failed downloading package ${package-name}."/>
                    </catch>
                </trycatch>
            </else>
        </if>
    </target>

    <!-- Unpack the package. -->
    <target name="package-unpack" hidden="true">
        <!-- Create extraction directory if needed. -->
        <if>
            <not>
                <available file="${package-extract-location}" type="dir"/>
            </not>
            <then>
                <mkdir dir="${package-extract-location}" />
            </then>
        </if>
        <if>
            <not>
                <isset property="${package-extract-options}" />
            </not>
            <then>
                <property name="package-extract-options" value="" />
            </then>
        </if>
        <!-- Use the faster native commands on UNIX systems. -->
        <if>
            <os family="unix"/>
            <then>
                <echo msg="Unpacking ${package-name} into ${package-extract-location}."/>
                <exec command='tar xzf "${package-cache-location}/${package-name}" ${package-extract-options} -C "${package-extract-location}"' dir="${project.basedir}" passthru="true" checkreturn="true" />
            </then>
            <else>
                <untar file="${package-cache-location}/${package-name}" todir="${package-extract-location}"/>
            </else>
        </if>
    </target>

   <!-- Create temp dirs. -->
    <if>
        <available file="${share.path.global}" type="dir"/>
        <then>
            <echo msg="Global share directory ${share.path.global} available." level="${level}" />
        </then>
        <else>
            <trycatch>
                <try>
                    <exec
                        command="mkdir -p ${share.path.global}"
                        checkreturn="true" />
                    <echoproperties
                        prefix="share.path."
                        destfile="${project.tmp.dir}/build.properties.share" />
                </try>
                <catch>
                    <echo msg="Unable to create global share directory." level="warning"/>
                    <echo msg="Switching over to local tmp dir for caching." />
                    <property
                        name="share.path.global"
                        value="${project.tmp.dir}/${share.name}"
                        override="true" />
                    <mkdir dir="${share.path.global}" />
                </catch>
            </trycatch>
        </else>
    </if>
    <if>
        <available file="${project.tmp.dir}" type="dir"/>
        <then>
            <echo msg="Temporary directory ${project.tmp.dir} available." level="${level}" />
        </then>
        <else>
            <mkdir dir="${project.tmp.dir}"/>
        </else>
    </if>

    <!-- Highest priority to env variables. -->
    <property environment="env" />

    <!-- Set compose project name if available. -->
    <if>
        <isset property="env.COMPOSE_PROJECT_NAME" />
        <then>
            <property name="docker.project.id" value="${env.COMPOSE_PROJECT_NAME}" override="true" />
        </then>
    </if>

    <!-- Subsequently import the project specific build file." -->
    <if>
        <available file="build.project.xml" />
        <then>
            <import file="build.project.xml" />
        </then>
    </if>

    <!-- Macke sure project id for DB is valid with underscore instead of hyphen. -->
    <php function="str_replace" returnProperty="db.name" level="debug">
        <param value="-"/>
        <param value="_"/>
        <param value="${db.name}"/>
    </php>

    <!-- Disable output on consecutive phing calls. -->
    <property name="logoutput" value="false" override="true" />
    <property name="level" value="verbose" override="true" />

</project>
