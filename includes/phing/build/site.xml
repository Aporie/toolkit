<?xml version="1.0" encoding="UTF-8" ?>

<project default="help">

    <!-- Import helper targets if called here directly. -->
    <if>
         <available file="help.xml" />
         <then>
             <import file="help.xml" />
         </then>
     </if>

    <target
        name="build-dev"
        description="Build a local development version of the site (build-site-environment)."
        depends="build-site-environment" />

    <target
        name="build-dist"
        description="Build a site intended as a release package (build-site-release)."
        depends="build-site-release" />

    <!-- Create code base. -->
    <target
        name="build-site-environment"
        depends="
            project-site-backup,
            project-set-distribution-version,
            project-set-env,
            project-set-profile,
            build-site-link-resources,
            build-site-make,
            build-site-composer-install,
            project-modules-devel-dl,
            project-site-restore" />

    <!-- Create distribution code base. -->
    <target
        name="build-site-release"
        depends="
            project-set-dist,
            project-delete-site,
            build-build-site-make,
            build-site-copy-resources,
            build-build-site-composer-install" />

    <!-- Make the development version of the subsite. -->
    <target name="build-site-make">
        <echo msg="Make the subsite." />
        <phingcall target="drush-make-no-core">
            <property name="make-file" value="${resources.dir.site.make}" />
            <property name="make-folder" value="${build.profile.dir.sites}" />
            <property name="make-destination" value="${project.id}" />
        </phingcall>
    </target>

    <!-- Symlink the source folders for easy development. -->
    <target name="build-site-link-resources">
        <symlink-property-contents
            prefix="lib.dir."
            origindir="${lib.dir}"
            targetdir="${build.subsite.dir}"
            overwrite="true"
        />
        <symlink-property-contents
                prefix="resources.dir."
                origindir="${resources.dir}"
                targetdir="${build.subsite.dir}"
                overwrite="true"
        />
    </target>

    <!-- Generate the makefile used to download development modules. -->
    <target name="project-modules-devel-mf">
        <echo msg="Generate the makefile for development modules." />
        <if>
            <available file="${project.tmp.devel.make}" type="file" property="devel.makefile.available" />
            <then>
                <echo message="Deleting existing makefile." />
                <delete file="${project.tmp.devel.make}" failonerror="false" />
            </then>
        </if>
        <drushmf
            makeFile="${project.tmp.devel.make}"
            coreVersion="${profile.core}"
            projects="${devel.mdls.dl}"
            defaultProjectDir="${devel.mdls.dir}"
        />
    </target>

    <!-- Build release package. -->
    <target name="build-site-release-package" description="Build subsite source code release package." depends="build-site-release">
        <mkdir dir="${project.release.path}" />
        <exec command="tar -czf ${project.release.path}/${project.release.name}.tar.gz ${build.dist}" />
    </target>

   <!-- Install Composer dist dependencies for the subsite. -->
    <target name="build-build-site-composer-install">
        <echo msg="Run 'composer install --no-dev' in the build destination folder." />
        <composer command="install" composer="${project.bin.composer}">
            <arg value="--working-dir=${build.dist.dir}" />
            <arg value="--no-interaction" />
            <arg value="--no-plugins" />
            <arg value="--no-suggest" />
            <arg value="--no-dev" />
            <arg value="--ansi" />
        </composer>
    </target>

    <!-- Copy resources into the build folder. -->
    <target name="build-site-copy-resources">
        <echo msg="Copy custom resources." />
        <!-- Copy our custom modules. -->
        <phingcall target="copy-folder">
            <property name="copy.source.path" value="${lib.dir.modules}" />
            <property name="copy.destination.path" value="${build.dist.dir.modules.custom}" />
            <property name="build.haltonerror.dir.copy" value="false" override="true"/>
        </phingcall>
        <!-- Copy our custom features. -->
        <phingcall target="copy-folder">
            <property name="copy.source.path" value="${lib.dir.modules.features}" />
            <property name="copy.destination.path" value="${build.dist.dir.modules.features}" />
            <property name="build.haltonerror.dir.copy" value="false" override="true"/>
        </phingcall>
        <!-- Copy our custom themes. -->
        <phingcall target="copy-folder">
            <property name="copy.source.path" value="${lib.dir.themes}" />
            <property name="copy.destination.path" value="${build.dist.dir.themes}" />
            <property name="build.haltonerror.dir.copy" value="false" override="true"/>
        </phingcall>
        <!-- Copy our custom PSR-4 code. -->
        <phingcall target="copy-folder">
            <property name="copy.source.path" value="${lib.dir.source}" />
            <property name="copy.destination.path" value="${build.dist.dir.source}" />
            <property name="build.haltonerror.dir.copy" value="false" override="true"/>
        </phingcall>
        <!-- Copy composer configuration. -->
        <copy todir="${build.dist.dir}" file="${resources.dir.composer.json}" />
        <copy todir="${build.dist.dir}" file="${resources.dir.composer.lock}" />
    </target>

    <!-- Delete the previous distribution build. -->
    <target name="project-delete-site">
        <echo msg="Delete previous build." />
        <phingcall target="delete-folder">
            <property name="folder.to.delete" value="${build.dist.dir}" />
        </phingcall>
    </target>

    <!-- Make the distribution version of the subsite. -->
    <target name="build-build-site-make">
        <phingcall target="drush-make-no-core">
            <property name="make-file" value="${resources.dir.site.make}" />
            <property name="make-folder" value="${build.subsite.dir.modules}" />
        </phingcall>
    </target>

</project>
