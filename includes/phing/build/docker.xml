<?xml version="1.0" encoding="UTF-8" ?>

<project default="help">

    <!-- Import helper targets if called here directly. -->
    <if>
        <available file="help.xml" />
        <then>
            <import file="help.xml" />
        </then>
    </if>

    <!-- Start an environment with docker. -->
    <target name="docker-compose-up" description="Start docker project.">
        <echo msg="Starting containers for ${docker.project.id}" />
        <mkdir dir="${project.build.dir}" /> 
        <mkdir dir="${share.path.platform.packages.database}/platform-dev-${platform.package.version}" />
        <exec command="WORKSPACE=${project.basedir} DB_LOCATION_DIR=${share.path.platform.packages.database}/platform-dev-${platform.package.version} docker-compose -p ${docker.project.id} -f ${ssk.includes}/docker/docker-compose.yml up -d" />
        <rel-sym link="${project.basedir}/ssk-${docker.project.id}" target="${ssk.includes}/docker/dbash" overwrite="true" />
        <exec command="${project.basedir}/ssk-${docker.project.id} ps" passthru="true" />
    </target>

    <!-- Stop docker environment. -->
    <target name="docker-compose-stop" description="Stop docker project.">
        <echo msg="Stopping containers for ${docker.project.id}" />
        <exec command="docker-compose -p ${docker.project.id} -f ${ssk.root}/resources/docker/docker-compose.yml stop" />
        <exec command="${project.basedir}/ssk-${docker.project.id} ps" passthru="true" />
    </target>

    <!-- Remove docker environment. -->
    <target name="docker-compose-down" description="Trash docker project.">
        <echo msg="Removing containers and volumes for ${docker.project.id}" />
        <exec command="docker-compose -p ${docker.project.id} -f ${ssk.root}/resources/docker/docker-compose.yml down --volumes" />
        <delete file="${project.basedir}/ssk-${docker.project.id}" />
    </target>

   <!-- Backup database. -->
    <target name="docker-compose-backup" description="Backup database.">
        <echo msg="Backing up database for ${docker.project.id}" />
        <property name="db-dir" value="${project.tmp.dir}/databases/platform-dev/${platform.version.major}.${platform.version.minor}/${platform.version.major}.${platform.version.minor}.${platform.version.reference}" />
        <mkdir dir="${db-dir}" />
        <exec command="WORKSPACE=${project.basedir} COMPOSE_PROJECT_NAME=${docker.project.id} ${ssk.includes}/docker/dbash backup ${db-dir}" passthru="true" logoutput="false" />
    </target>

   <!-- Restore database. -->
    <target name="docker-compose-restore" description="Restore database.">
        <echo msg="Restoring database for ${docker.project.id}" />
        <property name="db-dir" value="${project.tmp.dir}/databases/platform-dev/${platform.version.major}.${platform.version.minor}/${platform.version.major}.${platform.version.minor}.${platform.version.reference}" />
        <mkdir dir="${db-dir}" />
        <exec command="WORKSPACE=${project.basedir} COMPOSE_PROJECT_NAME=${docker.project.id} ${ssk.includes}/docker/dbash restore ${db-dir}" passthru="true" logoutput="false" />
    </target>

</project>
