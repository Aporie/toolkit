<?xml version="1.0" encoding="UTF-8" ?>

<project default="help">

    <!-- Import helper targets if called here directly. -->
    <if>
         <available file="help.xml" />
         <then>
             <import file="help.xml" />
         </then>
     </if>

    <!-- Build test package. -->
    <target name="build-test-subsite-package" description="Build subsite tests code release package.">
        <mkdir dir="${project.release.path}" />
    </target>


    <!-- Run Behat tests. -->
    <target name="test-behat-exec">
        <behat
            executable="${behat.bin}"
            config="${behat.yml.path}"
            strict="${behat.options.strict}"
            verbose="${behat.options.verbosity}"
            passthru="${behat.options.passthru}"
        />
    </target>

    <!-- Set up Behat. -->
    <target name="test-behat-setup">
        <delete file="${behat.yml.path}" failonerror="false" quiet="true" />
        <echo message="Creating behat.yml configuration file" />
        <loadfile property="behat.yml.content" file="${behat.yml.template}">
            <filterchain>
                <replacetokens>
                    <token key="project.code.dir" value="${project.code.dir}" />
                    <token key="drupal.site.dir" value="${drupal.site.dir}" />
                    <token key="behat.base_url" value="${behat.base_url}" />
                    <token key="behat.formatter.name" value="${behat.formatter.name}" />
                </replacetokens>
            </filterchain>
        </loadfile>
        <echo message="${behat.yml.content}" file="${behat.yml.path}" />
    </target>

    <!-- Symlink the Behat bin and test directory in the subsite folder. -->
    <target name="test-behat-setup-link">
        <echo msg="Symlink the Behat bin and test directory in './sites/all'." />
        <rel-sym link="${project.basedir}/ssk/behat" target="${ssk.vendor}/bin/behat" overwrite="true"/>
        <rel-sym link="${platform.build.subsite.dir}/tests" target="${project.basedir}/tests" overwrite="true"/>
    </target>

    <!-- Set up Behat balancer. -->
    <target name="test-behat-setup-balancer">
        <behat:balancer
            containers="${behat.load_balancer.containers}"
            root="${behat.load_balancer.root}"
            destination="${behat.load_balancer.destination}"
            import="${behat.load_balancer.import}"
        />
    </target>

    <!-- Do quality assurance checks. -->
    <target name="test-phpcs-exec">
        <exec
            command="${ssk.bin}/phpcs"
            passthru="true"
            checkreturn="true"
        />
    </target>

    <!-- Set up PHP CodeSniffer. -->
    <target name="test-phpcs-setup" depends="test-phpcs-setup-prepush">
        <delete file="${phpcs.config}" failonerror="false" />
        <delete file="${phpcs.global.config}" failonerror="false" />
        <phpcsconf
            configFile="${phpcs.config}"
            extensions="${phpcs.extensions}"
            files="${phpcs.files}"
            globalConfig="${phpcs.global.config}"
            ignorePatterns="${phpcs.ignore}"
            passWarnings = "${phpcs.passwarnings}"
            reports="${phpcs.reports}"
            showProgress="${phpcs.progress}"
            showSniffCodes="${phpcs.sniffcodes}"
            standards="${phpcs.standards}"
            installedPaths="${phpcs.installed.paths}"
        />
    </target>

    <!-- Setup the PHP CodeSniffer pre-push hook. -->
    <target name="test-phpcs-setup-prepush">
        <if>
            <equals arg1="${phpcs.prepush.enable}" arg2="1" />
            <then>
                <echo message="Enabling git pre-push hook." />
                <mkdir dir="${project.basedir}/resources/git/hooks/pre-push"/>
                <rel-sym link="${phpcs.prepush.destination}" target="${phpcs.prepush.source}" overwrite="true" />
            </then>
           <else>
                <echo message="Disabling git pre-push hook." />
                <delete file="${phpcs.prepush.destination}" failonerror="false" quiet="true" />
          </else>
        </if>
    </target>

    <!-- Set up PHPUnit. -->
    <target name="test-phpunit-setup">
        <copy todir="${phpunit.dir}" overwrite="true">
            <fileset dir="${phpunit.dir}" casesensitive="yes">
                <include name="*.xml.dist"/>
            </fileset>
            <filterchain>
                <replacetokens begintoken="{{ " endtoken=" }}">
                    <token key="phpunit.base_url" value="${phpunit.base_url}" />
                    <token key="platform.build.dir" value="${platform.build.dir}" />
                    <token key="phpunit.dir" value="${phpunit.dir}" />
                </replacetokens>
            </filterchain>
            <mapper type="glob" from="*.xml.dist" to="*.xml" />
        </copy>
        <symlink link="${phing.project.build.dir}" overwrite="true">
            <fileset dir="${phpunit.dir}" casesensitive="yes">
                <include name="*.yml"/>
            </fileset>
        </symlink>
        <symlink link="${phing.project.build.dir}/tests" target="../tests" />
        <symlink link="bin/phpunit" target="../${phing.project.build.dir}/vendor/bin/phpunit" overwrite="true"/>
    </target>

    <!-- Do quality assurance checks. -->
    <target name="test-qa-exec">
        <exec
            command="${ssk.bin}/qa \
                review:full \
                --no-interaction \
                --ansi"
            passthru="true"
            checkreturn="true"
        />
    </target>

</project>
