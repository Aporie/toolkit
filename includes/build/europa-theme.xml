<?xml version="1.0" encoding="UTF-8" ?>

<project default="help">

    <!-- Import helper targets if called here directly. -->
    <if>
         <available file="help.xml" />
         <then>
             <import file="help.xml" />
         </then>
    </if>

    <!-- This step in future will become a part of a build on the new Europa theme repository. -->
    <target name="theme-europa-download-extract">
        <!-- Download the Europa theme archive for a given branch. -->
        <exec
            command="curl -L https://github.com/ec-europa/ec_europa/releases/download/${ec_europa.version}/ec_europa-${ec_europa.version}.tar.gz > profiles/common/themes/ec_europa.tar.gz"
            passthru="true" />
        <!-- Extract the archive -->
        <mkdir dir="profiles/common/themes/ec_europa" />
        <exec
            dir="profiles/common/themes"
            command="tar xzf ec_europa.tar.gz --strip=1 -C ec_europa"
            passthru="true" />
        <delete file="profiles/common/themes/ec_europa.tar.gz" quiet="true" />
        <phingcall target="theme-europa-embed-ecl-assets" />
    </target>

    <target name="theme-europa-embed-ecl-assets">
        <!-- Download the ECL release package. -->
        <exec
            command="curl -L https://github.com/ec-europa/europa-component-library/releases/download/${ecl.version}/framework.tar.gz > profiles/common/themes/ec_europa/framework.tar.gz"
            passthru="true" />
        <!-- Extract and embed the ECL artifacts into the Europa theme. -->
        <exec
            dir="profiles/common/themes/ec_europa"
            command="tar xzf framework.tar.gz --strip=1 -C assets"
            passthru="true" />
        <delete file="profiles/common/themes/ec_europa/framework.tar.gz" quiet="true" />
    </target>

    <!-- Creates symlinks for the atomium and europa themes. -->
    <target name="theme-europa-create-symlinks" >
        <symlink link="profiles/${platform.profile.name}/themes">
            <fileset dir="${subsite.resources.profiles.common.themes.dir}">
                <include name="ec_europa" />
            </fileset>
        </symlink>
    </target>

    <!-- Cloning and checking out the branch of the Atomium and EC Europa theme repositories. -->
    <target name="theme-europa-repo-clone">
        <!-- Deleting theme directories before cloning -->
        <delete dir="${platform.resources.profiles.common.themes.dir}/atomium" quiet="true"/>
        <delete dir="${platform.resources.profiles.common.themes.dir}/ec_europa" quiet="true"/>

        <!-- Cloning the Atomium theme repo into the common profiles directory -->
        <echo msg = "Cloning the Atomium theme repository."/>
        <gitclone
            repository="${platform.theme.atomium.repo.url}"
            targetPath="${platform.resources.profiles.common.themes.dir}/atomium"/>
        <!-- Checking out the configured branch in the cloned repo -->
        <gitcheckout
            repository="${platform.resources.profiles.common.themes.dir}/atomium"
            branchname="${platform.theme.atomium.repo.branch}"/>

        <!-- cloning the EC Europa theme repo into the common profiles directory -->
        <echo msg = "Cloning the EC Europa theme repository."/>
        <gitclone
            repository="${platform.theme.europa.repo.url}"
            targetPath="${platform.resources.profiles.common.themes.dir}/ec_europa"/>
        <!-- Checking out the configured branch in the cloned repo -->
        <gitcheckout
            repository="${platform.resources.profiles.common.themes.dir}/ec_europa"
            branchname="${platform.theme.europa.repo.branch}"/>
    </target>

    <!-- Generating assets -->
    <target name="theme-europa-build">
        <exec
            command="npm install"
            passthru="true"
            dir="${platform.resources.profiles.common.themes.dir}/ec_europa"
        />
        <exec
            command="npm run build"
            passthru="true"
            dir="${platform.resources.profiles.common.themes.dir}/ec_europa"
        />
        <!-- Deleting *.map files (currently there is a bug in the ecl-builder) -->
        <delete>
            <fileset dir="${platform.resources.profiles.common.themes.dir}/ec_europa/assets/css">
                <include name="*.map" />
            </fileset>
            <fileset dir="${platform.resources.profiles.common.themes.dir}/ec_europa/wysiwyg">
                <include name="*.map" />
            </fileset>
        </delete>
    </target>
</project>
