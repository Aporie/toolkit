<?xml version="1.0" encoding="UTF-8" ?>

<project name="Starterkit" default="help">

    <!-- Check if site exists. -->
    <if>
        <available file="${platform.build.settings.dir}/settings.php" type="file"/>
        <then>
            <property name="site-detected" value="1" />
        </then>
    </if>

    <!-- Check if backup exists. -->
    <if>
        <available file="${platform.rebuild.backup.destination}" type="dir"/>
        <then>
            <property name="backup-detected" value="1" />
        </then>
    </if>

    <!-- Symlink the Behat bin and test directory in the subsite folder. -->
    <target name="test-behat-setup-link">
        <echo msg="Symlink the Behat bin and test directory in './sites/all'." />
        <rel-sym link="${project.basedir}/ssk/behat" target="${subsite.starterkit.vendor}/bin/behat" overwrite="true"/>
        <rel-sym link="${platform.build.subsite.dir}/tests" target="${project.basedir}/tests" overwrite="true"/>
    </target>

    <!-- Link site document root to Webserver document root. -->
    <target
        name="link-docroot"
        description="Create symlink from build to docroot.">
        <rel-sym link="${server.docroot}" target="${platform.build.dir}" overwrite="true" />
    </target>

    <!-- Create temp dirs. -->
    <target name="create-tmp-dirs" hidden="true">
        <if>
            <!-- Create the global cache directory if it doesn't exist. -->
            <not>
                <available file="${platform.package.cachedir}" type="dir"/>
            </not>
            <then>
                <mkdir dir="${platform.package.cachedir}"/>
            </then>
            <else>
                <echo msg="Directory ${platform.package.cachedir} exists."/>
            </else>
        </if>
        <if>
            <!-- Create the destination directory if it doesn't exist. -->
            <not>
                <available file="${platform.package.destination}" type="dir"/>
            </not>
            <then>
                <mkdir dir="${platform.package.destination}"/>
            </then>
            <else>
                <echo msg="Directory ${platform.package.destination} exists."/>
            </else>
        </if>
    </target>

    <!-- Build release package. -->
    <target name="build-release" description="Build subsite source code release package." depends="build-dist">
        <mkdir dir="${project.release.path}" />
        <exec command="tar -czf ${project.release.path}/${project.release.name}.tar.gz ${phing.subsite.build.dir}" />
    </target>

    <!-- Build test package. -->
    <target name="build-tests" description="Build subsite tests code release package.">
        <mkdir dir="${project.release.path}" />
    </target>

    <!-- Create code base. -->
    <target
        name="build-code"
        description="Build local version of subsite without install."
        depends="
            subsite-site-backup,
            platform-delete,
            platform-make,
            platform-link-resources,
            subsite-composer-install,
            test-behat-setup-link,
            test-behat-setup,
            platform-update-htaccess,
            test-phpcs-setup,
            subsite-modules-devel-dl,
            subsite-site-restore"
    />

    <!-- Build code base with backup restore. -->
    <target name="build-keep" description="Build local version of subsite with backup and restore.">
        <!-- Execute build-dev with automatic rebuild enabled. -->
        <phingcall target="build-dev">
            <property name="platform.rebuild.auto" value="1" override="true"/>
        </phingcall>
    </target>

    <!-- Create distribution code base. -->
    <target
        name="build-dist"
        hidden="true"
        depends="
            dist-delete,
            dist-make,
            dist-copy-resources,
            dist-composer-install"
    />

</project>
