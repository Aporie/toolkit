<?xml version="1.0" encoding="UTF-8" ?>

<project default="help">

    <!-- Import helper targets if called here directly. -->
    <if>
         <available file="help.xml" />
         <then>
             <import file="help.xml" />
         </then>
     </if>

    <!-- Create code base. -->
    <target
        name="build-subsite-dev"
        description="Build local version of subsite without install."
        depends="
            subsite-site-backup,
            build-project-platform,
            subsite-make-subsite,
            subsite-resources-link,
            project-subsite-composer-install,
            test-behat-setup-link,
            test-behat-setup,
            build-project-htaccess,
            test-phpcs-setup,
            project-modules-devel-dl,
            subsite-site-restore" />

    <!-- Create distribution code base. -->
    <target
        name="build-subsite-dist"
        description="Build files of subsite for release package."
        depends="
            subsite-dist-delete,
            subsite-dist-make,
            subsite-dist-resources-copy,
            subsite-dist-composer-install" />

    <!-- Build code base with backup restore. -->
    <target name="build-project-rebuild-platform" description="Rebuild NextEuropa Platform code while keeping subsite.">
        <!-- Execute build-dev with automatic rebuild enabled. -->
        <phingcall target="build-subsite-dev">
            <property name="platform.rebuild.auto" value="1" override="true"/>
        </phingcall>
    </target>

    <!-- Build code base with backup restore. -->
    <target name="build-project-rebuild-subsite" description="Rebuild NextEuropa Subsite code while keeping platform.">
        <!-- TODO when subsite packages are available. -->
    </target>

    <!-- Make the development version of the subsite. -->
    <target name="subsite-make-subsite">
        <if>
            <available file="${site.make}" type="file" />
            <then>
                <echo msg="Make the subsite." />
                <phingcall target="drush-make-no-core">
                    <property name="drush.make.target.file" value="${site.make}" />
                    <property name="drush.make.root" value="${platform.build.dir}" />
                </phingcall>
            </then>
            <else>
                <echo msg="No make file found. Skipping..." />
            </else>
        </if>
    </target>

    <!-- Symlink the source folders for easy development. -->
    <target name="subsite-resources-link">
        <rel-sym link="${platform.build.subsite.modules.custom.dir}" target="${project.resources.modules.dir}" />
        <rel-sym link="${platform.build.subsite.modules.features.dir}" target="${project.resources.features.dir}" />
        <delete dir="${platform.build.subsite.themes.dir}" includeemptydirs="true" failonerror="false" />
        <rel-sym link="${platform.build.subsite.themes.dir}" target="${project.resources.themes.dir}" />
        <rel-sym link="${platform.build.subsite.source.dir}" target="${project.resources.source.dir}" />
        <rel-sym link="${platform.build.subsite.composer.json}" target="${project.resources.composer.json}" />
        <rel-sym link="${platform.build.subsite.composer.lock}" target="${project.resources.composer.lock}" />
    </target>

    <!-- Generate the makefile used to download development modules. -->
    <target name="project-modules-devel-mf">
        <echo msg="Generate the makefile for development modules." />
        <if>
            <available file="${subsite.temporary.development.make}" type="file" property="development.makefile.available" />
            <then>
                <echo message="Deleting existing makefile." />
                <delete file="${subsite.temporary.development.make}" failonerror="false" />
            </then>
        </if>
        <drushmf
            makeFile="${subsite.temporary.development.make}"
            coreVersion="${drupal.core.version}"
            projects="${development.modules.download}"
            defaultProjectDir="${development.modules.location}"
        />
    </target>

    <!-- Build release package. -->
    <target name="build-subsite-dist-package" description="Build subsite source code release package." depends="build-subsite-dist">
        <mkdir dir="${project.release.path}" />
        <exec command="tar -czf ${project.release.path}/${project.release.name}.tar.gz ${phing.subsite.build.dir}" />
    </target>

   <!-- Install Composer dist dependencies for the subsite. -->
    <target name="subsite-dist-composer-install">
        <echo msg="Run 'composer install --no-dev' in the build destination folder." />
        <composer command="install" composer="${composer.bin}">
            <arg value="--working-dir=${dist.build.dir}" />
            <arg value="--no-interaction" />
            <arg value="--no-plugins" />
            <arg value="--no-suggest" />
            <arg value="--no-dev" />
            <arg value="--ansi" />
        </composer>
    </target>

    <!-- Copy project.resources into the build folder. -->
    <target name="subsite-dist-resources-copy">
        <echo msg="Copy custom resources." />
        <!-- Copy our custom modules. -->
        <phingcall target="copy-folder">
            <property name="copy.source.path" value="${project.resources.modules.dir}" />
            <property name="copy.destination.path" value="${dist.build.modules.custom.dir}" />
            <property name="copy.path.haltonerror" value="false" override="true"/>
        </phingcall>
        <!-- Copy our custom features. -->
        <phingcall target="copy-folder">
            <property name="copy.source.path" value="${project.resources.features.dir}" />
            <property name="copy.destination.path" value="${dist.build.modules.features.dir}" />
            <property name="copy.path.haltonerror" value="false" override="true"/>
        </phingcall>
        <!-- Copy our custom themes. -->
        <phingcall target="copy-folder">
            <property name="copy.source.path" value="${project.resources.themes.dir}" />
            <property name="copy.destination.path" value="${dist.build.themes.dir}" />
            <property name="copy.path.haltonerror" value="false" override="true"/>
        </phingcall>
        <!-- Copy our custom PSR-4 code. -->
        <phingcall target="copy-folder">
            <property name="copy.source.path" value="${project.resources.source.dir}" />
            <property name="copy.destination.path" value="${dist.build.source.dir}" />
            <property name="copy.path.haltonerror" value="false" override="true"/>
        </phingcall>
        <!-- Copy composer configuration. -->
        <copy todir="${dist.build.dir}" file="${project.resources.composer.json}" />
        <copy todir="${dist.build.dir}" file="${project.resources.composer.lock}" />
    </target>

    <!-- Delete the previous distribution build. -->
    <target name="subsite-dist-delete">
        <echo msg="Delete previous build." />
        <phingcall target="delete-folder">
            <property name="folder.to.delete" value="${dist.build.dir}" />
        </phingcall>
    </target>

    <!-- Make the distribution version of the subsite. -->
    <target name="subsite-dist-make">
        <echo msg="Delete temporary build folder." />
        <phingcall target="delete-folder">
            <property name="folder.to.delete" value="${phing.subsite.tmp.dir}/build" />
        </phingcall>

        <echo msg="Make the subsite." />
        <!--
            Drush make builds the site as if it is part of a complete Drupal
            installation. The actual build is in the /sites/all subfolder. Build
            in a temporary folder and move the subsite into place when done.
         -->
        <if>
            <available file="${site.make}" type="file" />
            <then>
                <loadfile property="sitemake" file="${site.make}"/>
                <propertyregex
                    property="not.empty"
                    subject="${sitemake}"
                    pattern="([^#; ])(libraries\[|projects\[)"
                    match="$1"
                    casesensitive="false"
                    defaultvalue="empty"/>
                <if>
                    <not><equals arg1="${not.empty}" arg2="empty" /></not>
                    <then>
                        <phingcall target="drush-make-no-core">
                            <property name="drush.make.target.file" value="${site.make}" />
                            <property name="drush.make.root" value="${phing.subsite.tmp.dir}/build" />
                        </phingcall>
                    </then>
                    <else>
                       <echo msg="Empty make file found. Skipping... ${not.empty}" />
                       <mkdir dir="${phing.subsite.tmp.dir}/build/sites/all" />
                    </else>
                </if>
            </then>
            <else>
                <echo msg="No make file found. Skipping..." />
                <mkdir dir="${phing.subsite.tmp.dir}/build/sites/all" />
            </else>
        </if>

        <!-- Move the subsite to its destination. -->
        <echo msg='mv "${phing.subsite.tmp.dir}/build/sites/all/" "${dist.build.dir}"' />
        <exec
            command='mv "${phing.subsite.tmp.dir}/build/sites/all/" "${dist.build.dir}"'
            dir="${project.basedir}"
            passthru="true"
            checkreturn="true"
        />

        <echo msg="Clean up temporary build folder." />
        <phingcall target="delete-folder">
            <property name="folder.to.delete" value="${phing.subsite.tmp.dir}/build" />
        </phingcall>
    </target>

</project>
